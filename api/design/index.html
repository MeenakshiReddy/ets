<html>
<head>
    <title>WASP - Control PANEL
    </title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <script src="js/jquery-2.2.4.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/validator.min.js"></script>


    <link rel="stylesheet" href="styles/style.css">


    <script>

        var map = null;

        $(document).ready(function () {

            $("div.employee button").click(function (e) {

                //Sending location request
                var empCode = $(this).data("emp-code");

                //Changing status
                var pEmpStatus = $(this).siblings(".employee_status");
                $(pEmpStatus).text("Requesting for new location...");

                $.ajax({
                    url: '/v1/request_location',
                    type: 'GET',
                    data: {
                        id: 1,
                        emp_codes: "[" + empCode + "]"
                    },
                    success: function (data, status) {
                        if (!data.error) {
                            $(pEmpStatus).text("Location request sent");
                        } else {
                            $(pEmpStatus).text(data.message);
                        }
                    },
                    error: function (data) {
                        console.log(data);
                        $(pEmpStatus).text("ERROR: " + data.status + ", Please check your connection");
                    }

                });


                e.stopPropagation();
            });


            $("div.employee").click(function () {
                var lat = $(this).data("lat");
                var lon = $(this).data("lon");

                var gLatLon = new google.maps.LatLng(lat, lon);
                map.panTo(gLatLon);
            });

            //Building websocket
            var webSocket = new WebSocket("ws://localhost:8080/v1/ets_socket/1");

            //onOpen
            webSocket.onopen = function (evnt) {
                log("Socket opened");
            };

            //onMessage
            webSocket.onmessage = function (evnt) {
                log("onMessage:" + evnt.data);
            };

            webSocket.onclose = function (evnt) {
                log("Socket closed: " + evnt.data);
            };

            webSocket.onerror = function (evnt) {
                log("ERROR: " + evnt.data);
            };

            function log(message) {
                $("p#ws_status").append(message).append("\n");
            }


        });
    </script>

</head>
<body>


<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="index.jsp">
                WASP
            </a>
        </div>

        <ul class="nav navbar-nav navbar-right">
            <li><a href="index.jsp"><span class="glyphicon glyphicon-home"></span> Home</a></li>
            <li><a href="employees.jsp"><span class="glyphicon glyphicon-user"></span> Employees</a></li>
            <li><a href="settings.jsp"><span class="glyphicon glyphicon-cog"></span> Settings</a></li>
            <li><a href="signout.jsp"><span class="glyphicon glyphicon-log-out"></span> SignOut</a></li>
        </ul>
    </div>
</nav>

<div class="container-fluid">

    <div class="row">
        <div class="col-md-10">
            <!--Test row-->
            <p id="ws_status"></p>
        </div>
    </div>

    <div class="row">

        <!--Employees-->
        <div id="employees" class="col-md-3" style="height: 89%;overflow: scroll;">


            <div class="employee" data-name="Fouad Wehbi"
                 data-lat="25.162535140460566"
                 data-lon="55.41629871437395"
                 data-last-seen="15 Jan 2017 3:04:35 p.m.">
                <p class="employee_name"><strong>Fouad Wehbi
                </strong></p>
                <p class="employee_status">last seen 15 Jan 2017 3:04:35 p.m.
                </p>
                <button data-emp-code="mtZcB7qhqo" type="button" class="btn"><span
                        class="glyphicon glyphicon-refresh"></span>
                </button>
            </div>


            <div class="employee" data-name="001 kareem"
                 data-lat="25.24946291"
                 data-lon="55.29909011"
                 data-last-seen="Jan 15, 2017 2:21:22 PM">
                <p class="employee_name"><strong>001 kareem
                </strong></p>
                <p class="employee_status">last seen Jan 15, 2017 2:21:22 PM
                </p>
                <button data-emp-code="bs0RSZW664" type="button" class="btn"><span
                        class="glyphicon glyphicon-refresh"></span>
                </button>
            </div>


        </div>

        <!--Map-->
        <div class="col-md-9">
            <div id="map" style="width: 100%;height: 89%    ;">

            </div>
        </div>
    </div>
</div>
<script>

    //Initializing map
    function initMap() {

        var dubai = new google.maps.LatLng(25.276987, 55.296249);
        var mapCanvas = document.getElementById("map");
        var mapOptions = {
            center: dubai,
            zoom: 10
        }

        map = new google.maps.Map(mapCanvas, mapOptions);

        //Pinning last location of employees
        var employees = $("div#employees").children();
        console.log("Found " + employees.length + " employee(s)");

        for (var i = 0; i < employees.length; i++) {

            var name = $(employees[i]).data("name");
            var lat = $(employees[i]).data("lat");
            var lon = $(employees[i]).data("lon");

            if (!lat || !lon) {
                console.log("no location found for " + name);
                continue;
            }

            var lastSeen = $(employees[i]).data("last-seen");

            //Setting marker
            var gLatLon = new google.maps.LatLng(lat, lon);
            var marker = new google.maps.Marker({position: gLatLon});

            marker.setMap(map);

            //Building info window with employee name
            var infoWindow = new google.maps.InfoWindow(
                {
                    content: name + " - (" + lastSeen + ")"
                }
            );

            //Showing info window
            infoWindow.open(map, marker);

            //Click on zoom
            google.maps.event.addListener(marker, 'click', function () {
                map.setZoom(18);
                map.setCenter(marker.getPosition());
            });

        }
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwmri1d59R8EH5zyXAw-BXRcEMFUtKjA4&callback=initMap"></script>
</body>
</html>
